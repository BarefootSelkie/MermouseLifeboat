<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Director/1.2.8/director.min.js"></script>
  <script src="model.js"></script>
  <script src="viewmodel.js"></script>
  <script src="view.js"></script>
  <link href="https://unpkg.com/ionicons@4.5.9-1/dist/css/ionicons.min.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">

  <script>

    var currentView = "Overview";
    var router = null;

    var statusOrder = ['💚', '🔶', '🔴'];

    var pinBadges = {
      "Unavailable": '❌',
      "No": '❓',
      "Yes": '⭕'
    };

    // Custom sort function for sorting by date property
    var sortByDate = (a, b) => {
      if (a.date > b.date) { return 1; }
      if (a.date < b.date) { return -1; }
      return 0;
    };

    function draw() {

      $('#stats').html("");
      $('#stations').html("");
      $('#stationList').html("");

      switch (currentView) {

        // Main homepage view
        case "Overview":
          visitedStations
            .map((station) => makeStationViewModel(station.SAP_ID))
            .sort(sortByDate)
            .reverse()
            .forEach((station) => {
              var element = $(Handlebars.templates["stationFull"](station));
              $('#stations').append(element);
            });
          break;

        // Private dashboard listing visit information for all stations
        case "AllStations":
          var stationCount = lifeboatStationLocations.length;
          var visitedCount = visitedStations.filter((station) => station.Visits.length > 0).length;

          $('#stats').html("Visited: " + visitedCount + " (" + Math.round(100 * visitedCount / stationCount) + "%)");

          lifeboatStationLocations
            .map((station) => makeStationViewModel(station.SAP_ID))
            .sort((a, b) => { // sort alphabetically by name
              if (a.name < b.name) { return -1; }
              if (a.name > b.name) { return 1; }
              return 0;
            })
            .sort((a, b) => { // sort by visited stations first
              if (statusOrder.indexOf(a.status) < statusOrder.indexOf(b.status)) { return -1; }
              if (statusOrder.indexOf(a.status) > statusOrder.indexOf(b.status)) { return 1; }
              return 0;
            })
            .forEach((station) => {
              var element = $(Handlebars.templates["stationSummary"](station));
              $('#stationList').append(element);
            });
          break;
      }

    }

    function route() {

      router = Router({
        '/': () => { currentView = "Overview"; draw(); },
        '/allstations': () => { currentView = "AllStations"; draw(); },
        '/:stationid': (id) => { selectedStation = id; currentView = "Station"; draw(); }
      });

      router.init();

      draw();
    }

    $(() => {
      Promise.all([
        loadTemplates(),
        loadData()
      ])
      .then(() => route());
    });
  </script>

</head>

<body>
  <div id="title">Mermouse Lifeboat Project</div>
  <div id="stats"></div>
  <ul id="stations"></ul>
  <ul id="stationList"></ul>
</body>

</html>